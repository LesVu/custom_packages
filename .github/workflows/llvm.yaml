name: Build LLVM

on:
  workflow_dispatch:

jobs:
  llvm-debian:
    name: Build package on arm64
    runs-on: self-hosted
    timeout-minutes: 1440

    steps:
      - name: checkout
        uses: actions/checkout@v3

      - name: Install deps
        run: |
          export DEBIAN_FRONTEND=noninteractive
          git config --global http.postBuffer 157286400
          sudo cat <<EOF > "/etc/apt/sources.list"
          deb-src http://deb.debian.org/debian unstable main
          EOF
          apt-get update && apt-get install -q -y \
          git build-essential apt-utils git-buildpackage dh-autoreconf quilt dh-ocaml time libz3-dev cowbuilder pbuilder
          mkdir llvm-17
          cd llvm-17
          apt-get source llvm-toolchain-17
          cd ..

          echo "apt-mark hold hello hello-traditional" > command.sh
          pbuilder create --distribution bookworm
          pbuilder execute --save-after-exec ./command.sh

      - name: Build
        run: |
          cd llvm-17
          pbuilder build llvm-toolchain*.dsc

      - name: Move to debian repo
        run: |
          cp /var/cache/pbuilder/result/*.deb debian/pool
          rm -f debian/pool/*-dbg*.deb

      - name: Import GPG key
        uses: crazy-max/ghaction-import-gpg@v5
        with:
          gpg_private_key: ${{ secrets.GPG_PRIVATE_KEY }}

      - name: List GPG keys
        run: gpg -K

      - name: Write new package to repo
        run: |
          cd $GITHUB_WORKSPACE/debian
          rm Packages || echo "Failed to remove packages file"
          rm Packages.gz || echo "Failed to remove packages.gz file"
          rm Release || echo "Failed to remove release file"
          rm Release.gpg || echo "Failed to remove release.gpg file"
          rm InRelease || echo "Failed to remove inrelease file"
          dpkg-scanpackages --multiversion . > Packages
          gzip -k -f Packages
          apt-ftparchive release . > Release
          gpg --default-key LesVu -abs -o - Release > Release.gpg || error "failed to sign Release.gpg with gpg "
          gpg --default-key LesVu --clearsign -o - Release > InRelease || error "failed to sign InRelease with gpg"

      - name: Commit and push
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          file_pattern: 'debian/*'
